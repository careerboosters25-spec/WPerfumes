<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Checkout - WPerfumes</title>

    <!-- Main CSS (modularized) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/checkout.css') }}">
</head>

<body>
    <div class="container" role="main" aria-labelledby="checkout-heading">
        <div style="display:flex;align-items:center;justify-content:space-between;">
            <h2 id="checkout-heading" style="margin:0;">Checkout</h2>
        </div>

        <div id="discountPercentInfo" class="discount-info" style="display:none;" aria-live="polite"></div>

        <div class="grid">
            <!-- Left: Order form -->
            <div>
                <form id="orderForm">
                    <div class="form-group">
                        <label for="customer">Full Name</label>
                        <input id="customer" name="customer" required type="text" autocomplete="name" />
                    </div>

                    <div class="form-group">
                        <label for="email">Email Address</label>
                        <input id="email" name="email" required type="email" autocomplete="email" />
                    </div>

                    <div class="form-group">
                        <label for="phone">Phone Number</label>
                        <input id="phone" name="phone" type="text" autocomplete="tel" />
                    </div>

                    <div class="form-group">
                        <label for="address">Shipping Address</label>
                        <textarea id="address" name="address" rows="3" required></textarea>
                    </div>

                    <!-- COUNTRY / CITY fields -->
                    <div class="form-group">
                        <label for="countrySelect">Country</label>
                        <select id="countrySelect" name="country">
                            <option value="">-- Select a country (or leave blank to enter manually) --</option>
                            <option value="Bahrain">Bahrain</option>
                            <option value="Egypt">Egypt</option>
                            <option value="Kuwait">Kuwait</option>
                            <option value="Qatar">Qatar</option>
                            <option value="Saudi Arabia">Saudi Arabia</option>
                            <option value="UAE">UAE</option>
                            <option value="OTHER">Other (enter manually)</option>
                        </select>
                        <div class="small-muted" style="margin-top:6px;">If you don't select a country you can enter it
                            manually below.</div>
                    </div>

                    <div class="form-group" id="citySelectContainer" aria-hidden="true" style="display:none;">
                        <label for="citySelect">City</label>
                        <select id="citySelect" name="city">
                            <option value="">-- Select city --</option>
                        </select>
                    </div>

                    <div id="manualCountryCity" class="form-group" style="display:none;">
                        <label for="countryInput">Country (manual)</label>
                        <input id="countryInput" name="country_manual" type="text" placeholder="Enter country" />

                        <label for="cityInput" style="margin-top:8px;display:block;">City (manual)</label>
                        <input id="cityInput" name="city_manual" type="text" placeholder="Enter city" />
                        <div class="small-muted" style="margin-top:6px;">Use these fields if you prefer to type the
                            country and city.</div>
                    </div>
                    <!-- /COUNTRY / CITY fields -->

                    <input type="hidden" id="promo_code_hidden" name="promo_code" value="">

                    <div class="form-group">
                        <label for="paymentSelect">Select Payment Method</label>
                        <select id="paymentSelect" name="payment_method" class="payment-select" required>
                            <option value="Cash on Delivery" selected>Cash on Delivery</option>
                            <option value="Visa/Mastercard">Visa/Mastercard</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="date">Desired Delivery / Order Date</label>
                        <input id="date" name="date" type="datetime-local" />
                    </div>

                    <div class="form-buttons">
                        <button type="submit" id="checkoutBtn" class="btn-primary">Place Order</button>
                        <button type="button" id="buyNowBtn" class="btn-secondary">Buy Now</button>
                        <!-- Inline hint to explain disabled state (aria-live) -->
                        <div id="paymentHint" class="small-muted" aria-live="polite" style="margin-left:8px;"></div>
                    </div>

                    <div id="orderMsg" style="margin-top:12px;"></div>
                </form>
            </div>

            <!-- Right: Cart summary -->
            <aside class="cart-summary" aria-label="Cart summary">
                <h3 style="margin-top:0;margin-bottom:8px;">Order Summary</h3>

                <div style="margin-bottom:12px;">
                    <label for="promo_code_summary" style="font-weight:700;margin-bottom:6px;display:block;">Promo
                        Code</label>
                    <select id="promo_code_summary" name="promo_code_summary"
                        style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;">
                        <option value="">-- None --</option>
                    </select>
                    <div id="promoMsg" class="small-muted" style="margin-top:8px;"></div>
                </div>

                <div id="cartSummarySection" aria-live="polite"></div>

                <div style="margin-top:12px;">
                    <div class="small-muted">Payment on delivery available for eligible addresses.</div>
                </div>

                <!-- PayPal button placeholder (checkout page) -->
                <div id="paypal-button-container" style="margin-top:12px;"></div>
            </aside>
        </div>
    </div>

    <!-- PayPal SDK (sandbox client id) -->
    <script
        src="https://www.paypal.com/sdk/js?client-id=AfTRhyp1ftl9u6Cy6Tz6HT8bLlnH3YKaoLgLkw6xLAJkEtOz-dCKVzmyVqwVHZ2uCU6Jrm6zV3L8C06f&currency=USD"></script>

    <!-- PayPal helper (static file) -->
    <script src="{{ url_for('static', filename='js/paypal.js') }}"></script>

    <!-- Provide server-rendered values for static JS (placeholder image) -->
    <script>
        window.PLACEHOLDER_IMAGE = "{{ url_for('static', filename='images/placeholder.jpg') }}";
    </script>

    <!--
      NEW: Merge pending_buy_item into localStorage cart automatically when checkout page loads.

      Reason: when users click "Buy Now" on brand_detail.html we set localStorage.pending_buy_item
      and then open the checkout page in a new tab. Some checkout code reads the 'cart' key,
      so merge pending_buy_item into 'cart' here (before checkout.js runs) to ensure the
      checkout page sees the product instead of "cart is empty".

      This runs early (synchronously) and removes pending_buy_item after merging to avoid duplicates.
    -->
    <script>
        (function () {
            try {
                const pendingRaw = localStorage.getItem('pending_buy_item');
                if (!pendingRaw) return;
                const pending = JSON.parse(pendingRaw);
                if (!pending || !pending.id) {
                    // Not a valid pending item â€” remove it and exit.
                    localStorage.removeItem('pending_buy_item');
                    return;
                }

                const cartKey = 'cart';
                let cart = [];
                try { cart = JSON.parse(localStorage.getItem(cartKey) || '[]'); } catch (e) { cart = []; }

                const idStr = String(pending.id);
                const existing = cart.find(i => String(i.id) === idStr);

                if (existing) {
                    existing.quantity = (Number(existing.quantity) || 0) + (Number(pending.quantity) || 1);
                } else {
                    cart.push({
                        id: pending.id,
                        title: pending.title || pending.name || '',
                        brand: pending.brand || '',
                        price: Number(pending.unit_price || pending.price || 0),
                        image: pending.image || window.PLACEHOLDER_IMAGE || '',
                        quantity: Number(pending.quantity) || 1
                    });
                }

                localStorage.setItem(cartKey, JSON.stringify(cart));
                // Remove pending marker so it's not merged repeatedly
                localStorage.removeItem('pending_buy_item');

                // expose a small flag in case checkout.js wants to know we merged something
                window.__pending_item_merged_into_cart = true;
            } catch (err) {
                console.warn('Failed merging pending_buy_item into cart:', err);
            }
        })();
    </script>

    <!-- Page-specific JS (modularized) -->
    <script src="{{ url_for('static', filename='js/checkout.js') }}"></script>
</body>

</html>